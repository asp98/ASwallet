<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ASwallet Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .toggle-checkbox:checked { right: 0; border-color: #9333EA; }
    .toggle-checkbox:checked + .toggle-label { background-color: #9333EA; }
  </style>
</head>
<body class="bg-gradient-to-b from-gray-50 to-gray-100 text-gray-900 min-h-screen pb-24 font-sans">

<!-- Header -->
<div id="dashboardHeader" class="fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-purple-600 via-pink-500 to-orange-400 p-4 shadow-lg text-black rounded-b-2xl transform -translate-y-full transition-transform duration-500">
  <div class="flex justify-between items-center mb-3">
    <h1 class="text-xl font-bold tracking-wide">Dashboard</h1>
    <div class="flex gap-3 items-center">
      <!-- Toggle Currency -->
      <div class="flex items-center mr-2">
        <span class="text-xs font-medium mr-1">USD</span>
        <div class="relative inline-block w-10 mr-1 align-middle select-none">
          <input type="checkbox" id="currency-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-2 appearance-none cursor-pointer"/>
          <label for="currency-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
        </div>
        <span class="text-xs font-medium">IDR</span>
      </div>
      <button class="hover:scale-110 transition"><i data-lucide="eye" class="w-5 h-5"></i></button>
      <button class="hover:scale-110 transition relative">
        <i data-lucide="bell" class="w-5 h-5"></i>
        <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
      </button>
    </div>
  </div>

  <div class="flex justify-between items-center">
    <div>
      <p class="text-xs opacity-80">Total Balance</p>
      <h2 class="text-4xl font-extrabold mt-1 flex items-end drop-shadow">
        <span id="balance-amount">$0</span>
        <span class="text-lg ml-1 opacity-90" id="balance-cents">.00</span>
      </h2>
    </div>
  <!-- Tombol History Transparan -->
<button onclick="window.location.href='history.html'" 
        class="ml-3 bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm font-medium transition backdrop-blur-sm">
  <i data-lucide="clock" class="w-4 h-4"></i> History
</button>
</div>
</div>

<!-- Spacer -->
<div class="h-32"></div>

<script>
  window.addEventListener("load", () => {
    const header = document.getElementById("dashboardHeader");
    setTimeout(() => { header.classList.remove("-translate-y-full"); }, 100);
  });
</script>

<!-- Content -->
<div class="pt-2 px-4"></div>

<!-- Asset List -->

<div class="p-3 space-y-3" id="asset-list">
  <h3 class="text-lg font-semibold text-gray-700 mb-2">My Assets</h3>
  
  <div class="asset-card" data-id="btc" data-label="BTC" data-chain="bitcoin " data-logo="btc.png"></div>
  
  <div class="asset-card" data-id="usdt" data-label="Tether USD" data-chain="BNB (BEP20)" data-logo="tether-logo.png"></div>
  
  <div class="asset-card" data-id="trx" data-label="Tron" data-chain="TRX (TRC20)" data-logo="tron-logo.png"></div>
  <div class="asset-card" data-id="usdc" data-label="USD Coin" data-chain="ETH (ERC20)" data-logo="USD_COIN_icon.png"></div>
  <div class="asset-card" data-id="bnb" data-label="BNB" data-chain="BNB (BEP20)" data-logo="bnb.png"></div>
  <div class="asset-card" data-id="eth" data-label="Ethereum" data-chain="ETH (ERC20)" data-logo="ethereum.png"></div>
</div>

<!-- Bottom Navigation -->
<div class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-gray-200 flex justify-around py-3 z-50 shadow-lg">
  <a href="dashboard.html" class="flex flex-col items-center text-purple-600 font-semibold hover:scale-110 transition">
    <i data-lucide="home" class="w-6 h-6 mb-1"></i><span class="text-xs">Home</span>
  </a>
  <a href="card.html" class="flex flex-col items-center text-gray-500 hover:text-purple-600 hover:scale-110 transition">
    <i data-lucide="credit-card" class="w-6 h-6 mb-1"></i><span class="text-xs">Card</span>
  </a>
  <a href="home.html" class="flex flex-col items-center text-gray-500 hover:text-purple-600 hover:scale-110 transition">
    <i data-lucide="grid" class="w-6 h-6 mb-1"></i><span class="text-xs">Profile</span>
  </a>
</div>

<!-- Scripts -->
<script>
  lucide.createIcons();

  let isIDRMode = false;
  let usdToIdrRate = 15000;

  // Ambil user dari localStorage
  const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!currentUser) {
    alert("Anda belum login.");
    window.location.href = "auth.html";
  }

  // Nilai tukar (dummy)
  async function fetchExchangeRate() { usdToIdrRate = 16400; }

  function formatRupiah(amount) {
    return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(amount);
  }
  function formatDollar(amount) {
    const dollar = Math.floor(amount);
    const cents = (amount % 1).toFixed(2).split(".")[1];
    return { dollar, cents };
  }

  function displayBalance() {
    const saldo = currentUser.saldo || 0;
    if (isIDRMode) {
      document.getElementById("balance-amount").textContent = formatRupiah(saldo * usdToIdrRate);
      document.getElementById("balance-cents").textContent = "";
    } else {
      const { dollar, cents } = formatDollar(saldo);
      document.getElementById("balance-amount").textContent = `$${dollar}`;
      document.getElementById("balance-cents").textContent = `.${cents}`;
    }
  }

  function updateAssetDisplay() {
    document.querySelectorAll('.asset-item').forEach(item => {
      const id = item.id.replace('asset-', '');
      const priceEl = document.getElementById(`price-${id}`);
      if (priceEl) {
        const currentPrice = parseFloat(priceEl.dataset.usdPrice || 0);
        priceEl.textContent = isIDRMode ? formatRupiah(currentPrice * usdToIdrRate) : `$${currentPrice.toFixed(id === "trx" ? 4 : 2)}`;
      }
    });
  }

  document.getElementById('currency-toggle').addEventListener('change', function() {
    isIDRMode = this.checked;
    displayBalance();
    updateAssetDisplay();
  });

  // Render asset cards
  document.querySelectorAll('.asset-card').forEach(div => {
    const id = div.dataset.id, label = div.dataset.label, chain = div.dataset.chain, logo = div.dataset.logo;
    div.innerHTML = `
      <div class="bg-white rounded-2xl p-4 flex justify-between items-center shadow-md hover:shadow-lg transition cursor-pointer asset-item" id="asset-${id}">
        <div class="flex items-center gap-4">
          <img src="${logo}" class="w-10 h-10 rounded-full border border-gray-200" alt="${label}" onerror="this.src='default-logo.png'">
          <div><p class="font-semibold text-gray-800">${label}</p><p class="text-xs text-gray-500">${chain}</p></div>
        </div>
        <div class="text-right">
          <p class="text-sm font-medium text-gray-700" id="price-${id}">$0.00</p>
          <p class="text-xs text-gray-500" id="amount-${id}">0.0000</p>
        </div>
        <div class="text-right ml-3"><p class="text-sm font-medium text-gray-700">1.0000</p><p class="text-xs font-semibold" id="change-${id}">↓ -0.00%</p></div>
      </div>
      <div class="hidden action-panel mt-2 p-3 bg-purple-50 rounded-xl flex justify-center gap-8">
        <a href="deposite.html" class="flex flex-col items-center"><div class="bg-purple-600 p-3 rounded-full text-white shadow-md hover:scale-110 transition"><i data-lucide="arrow-down-circle" class="w-6 h-6"></i></div><span class="text-xs mt-1 font-medium">Receive</span></a>
        <a href="withdraw.html" class="flex flex-col items-center"><div class="bg-orange-500 p-3 rounded-full text-white shadow-md hover:scale-110 transition"><i data-lucide="minus-circle" class="w-6 h-6"></i></div><span class="text-xs mt-1 font-medium">Transfer</span></a>
      </div>`;
  });
  lucide.createIcons();

  document.querySelectorAll('.asset-item').forEach(item => {
    item.addEventListener('click', () => {
      const panel = item.parentElement.querySelector('.action-panel');
      panel.classList.toggle('hidden');
    });
  });

  async function fetchCryptoPrices() {
    try {
      const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,tether,ethereum,tron,usd-coin,binancecoin&vs_currencies=usd&include_24hr_change=true");
      const data = await res.json();
      updateAsset("btc", data.bitcoin.usd, data.bitcoin.usd_24h_change);
      
      updateAsset("usdt", data.tether.usd, data.tether.usd_24h_change);
      updateAsset("eth", data.ethereum.usd, data.ethereum.usd_24h_change);
      updateAsset("trx", data.tron.usd, data.tron.usd_24h_change);
      updateAsset("usdc", data["usd-coin"].usd, data["usd-coin"].usd_24h_change);
      updateAsset("bnb", data.binancecoin.usd, data.binancecoin.usd_24h_change);
    } catch (e) { console.error("Gagal memuat harga:", e); }
  }

  function updateAsset(id, price, change) {
    const priceEl = document.getElementById(`price-${id}`);
    const changeEl = document.getElementById(`change-${id}`);
    const amountEl = document.getElementById(`amount-${id}`);
    priceEl.dataset.usdPrice = price;
    changeEl.dataset.change = change;
    priceEl.textContent = isIDRMode ? formatRupiah(price * usdToIdrRate) : `$${price.toFixed(id === "trx" ? 4 : 2)}`;
    const arrow = change < 0 ? "↓" : "↑";
    const color = change < 0 ? "text-red-500" : "text-green-500";
    changeEl.textContent = `${arrow} ${Math.abs(change).toFixed(2)}%`;
    changeEl.className = `text-xs font-semibold ${color}`;
    const userAssetUSD = currentUser?.aset?.[id] || 0;
    const amountOwned = price > 0 ? (userAssetUSD / price).toFixed(4) : "0.0000";
    amountEl.textContent = amountOwned;
  }

  async function initApp() {
    await fetchExchangeRate();
    displayBalance();
    fetchCryptoPrices();
    setInterval(fetchCryptoPrices, 10000);
  }
  initApp();
</script>
</body>
</html>